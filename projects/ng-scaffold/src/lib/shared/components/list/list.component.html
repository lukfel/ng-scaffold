<div class="lf-list" cdkDropListGroup>
  <!-- Header -->
  @if (header) {
    <div class="lf-list-item lf-list-item-header">
      <!-- avatar -->
      @if (header.avatar) {
        <div class="lf-list-item-avatar px-2">
          <img [src]="header.avatar" alt="Avatar of header" (error)="onImageError($event)" />
        </div>
      } @else if (header.matIcon || header.svgIcon) {
        <div class="lf-list-item-avatar px-2">
          <!-- icon -->
          @if (header.matIcon) {
            <mat-icon [class.material-icons-outlined]="libraryConfig?.outlineIcons">
              {{ header.matIcon }}
            </mat-icon>
          } @else if (header.svgIcon) {
            <mat-icon [svgIcon]="header.svgIcon"></mat-icon>
          }
        </div>
      } @else if (hasAvatars) {
        <div class="lf-list-item-avatar px-2"></div>
      }

      <!-- title -->
      <div class="lf-list-item-title-wrapper flex-row px-2">
        @for (item of header.items; track $index) {
          <span [class.clickable]="item.sortToken" (click)="updateSortToken(item.sortToken)">
            {{ item.title }}
            @if (sortToken === item.sortToken) {
              <mat-icon class="lf-list-item-sort-icon">
                {{ sortAsc ? "arrow_downward" : "arrow_upward" }}
              </mat-icon>
            }
          </span>
        }
      </div>

      <!-- buttons -->
      <div class="lf-list-item-buttons">
        @for (button of header.buttons; track button.id) {
          @if (button.label) {
            <button
              mat-button
              class="lf-list-item-button ml-2"
              [class.disabled]="button.disabled"
              [ngClass]="button.cssClass"
              [disabled]="button.disabled"
              [matTooltip]="button.tooltip"
              (click)="clickButton({ buttonId: button.id, item: null! }, $event)">
              <!-- icon -->
              @if (button.matIcon) {
                <mat-icon [class.material-icons-outlined]="libraryConfig?.outlineIcons">
                  {{ button.matIcon }}
                </mat-icon>
              } @else if (button.svgIcon) {
                <mat-icon [svgIcon]="button.svgIcon"></mat-icon>
              }
              {{ button.label }}
            </button>
          } @else {
            <button
              mat-icon-button
              class="lf-list-item-icon ml-2"
              [class.disabled]="button.disabled"
              [ngClass]="button.cssClass"
              [disabled]="button.disabled"
              [matTooltip]="button.tooltip"
              (click)="clickButton({ buttonId: button.id, item: null! }, $event)">
              <!-- icon -->
              @if (button.matIcon) {
                <mat-icon [class.material-icons-outlined]="libraryConfig?.outlineIcons">
                  {{ button.matIcon }}
                </mat-icon>
              } @else if (button.svgIcon) {
                <mat-icon [svgIcon]="button.svgIcon"></mat-icon>
              }
            </button>
          }
        }
      </div>

      <!-- checkbox -->
      @if (config?.enableSelection && !config?.disableMultiselect) {
        <div class="lf-list-item-checkbox ml-3">
          <mat-checkbox
            [(ngModel)]="allSelected"
            [indeterminate]="someSelected"
            (change)="selectAll($event)"></mat-checkbox>
        </div>
      }
    </div>
    <mat-divider></mat-divider>
  }

  <!-- Grouped Items -->
  @if (config?.mode === "group" && groupedItems) {
    @for (group of groupedItems | keyvalue; track group.key; let first = $first) {
      <div class="lf-list-group" [class.mt-4]="!first">
        @if (group.key) {
          <div class="lf-list-item lf-list-group-header">
            <div class="lf-list-item-avatar px-2"></div>
            <div class="lf-list-item-title-wrapper flex-row px-2">
              <span>{{ group.key }}</span>
            </div>
          </div>
        }
        <div
          [id]="group.key"
          cdkDropList
          [cdkDropListData]="group.value"
          [cdkDropListDisabled]="!config?.enableDragging"
          [cdkDropListConnectedTo]="connectedDropListIds"
          (cdkDropListDropped)="dropItem($event, group.key)"
          [class.drop-zone]="config?.enableDragging && group.value.length <= 0">
          @for (item of group.value; track item.id; let last = $last) {
            <div
              cdkDrag
              [cdkDragData]="item"
              [cdkDragDisabled]="item.disabled || !config?.enableDragging">
              <ng-container
                [ngTemplateOutlet]="listItemTemplate"
                [ngTemplateOutletContext]="{ $implicit: item, last: last }"></ng-container>
            </div>
          }
        </div>
      </div>
    }
    <!-- Flat Items -->
  } @else {
    <div
      [id]="dropListId"
      cdkDropList
      [cdkDropListData]="items"
      [cdkDropListDisabled]="!config?.enableDragging"
      [cdkDropListConnectedTo]="connectedDropListIds"
      (cdkDropListDropped)="dropItem($event, dropListId)"
      [class.drop-zone]="config?.enableDragging && items.length <= 0">
      @for (item of items; track item.id; let last = $last) {
        <div
          cdkDrag
          [cdkDragData]="item"
          [cdkDragDisabled]="item.disabled || !config?.enableDragging">
          <ng-container
            [ngTemplateOutlet]="listItemTemplate"
            [ngTemplateOutletContext]="{ $implicit: item, last: last }"></ng-container>
        </div>
      }
    </div>
  }

  <!-- Item (template) -->
  <ng-template #listItemTemplate let-item let-last="last">
    <div
      class="lf-list-item lf-list-item-data"
      [class.active]="item.checked"
      [class.disabled]="item.disabled"
      [class.clickable]="item.clickable && !item.disabled"
      [ngClass]="item.cssClass"
      matRipple
      [matRippleDisabled]="!item.clickable"
      (click)="item.clickable && !item.disabled ? clickItem(item, $event) : null">
      <!-- avatar -->
      @if (avatarTemplate) {
        <ng-container
          [ngTemplateOutlet]="avatarTemplate.templateRef"
          [ngTemplateOutletContext]="{ $implicit: item }"></ng-container>
      } @else if (item.avatar) {
        <div class="lf-list-item-avatar px-2">
          <img
            [src]="item.avatar"
            [alt]="'Avatar of ' + item.title"
            (error)="onImageError($event)" />
        </div>
      } @else if (item.matIcon || item.svgIcon) {
        <div class="lf-list-item-avatar px-2">
          <!-- icon -->
          @if (item.matIcon) {
            <mat-icon [class.material-icons-outlined]="libraryConfig?.outlineIcons">
              {{ item.matIcon }}
            </mat-icon>
          } @else if (item.svgIcon) {
            <mat-icon [svgIcon]="item.svgIcon"></mat-icon>
          }
        </div>
      }

      <!-- title -->
      <div class="lf-list-item-title-wrapper px-2">
        <span class="lf-list-item-title">
          @if (titleTemplate) {
            <ng-container
              [ngTemplateOutlet]="titleTemplate.templateRef"
              [ngTemplateOutletContext]="{ $implicit: item }"></ng-container>
          } @else {
            {{ item.title }}
          }
        </span>
        @if (item.subtitle || subtitleTemplate) {
          <span class="lf-list-item-subtitle">
            @if (subtitleTemplate) {
              <ng-container
                [ngTemplateOutlet]="subtitleTemplate.templateRef"
                [ngTemplateOutletContext]="{ $implicit: item }"></ng-container>
            } @else {
              {{ item.subtitle }}
            }
          </span>
        }
      </div>

      <!-- buttons -->
      <div class="lf-list-item-buttons">
        @if (buttonsTemplate) {
          <ng-container
            [ngTemplateOutlet]="buttonsTemplate.templateRef"
            [ngTemplateOutletContext]="{ $implicit: item }"></ng-container>
        } @else {
          @let combinedButtons = getCombinedButtons(item);
          @for (button of combinedButtons; track button.id) {
            @if (!item.hiddenButtonIds?.includes(button.id)) {
              @let disabled =
                button.disabled || item.disabled || item.disabledButtonIds?.includes(button.id);
              @if (button.label) {
                <button
                  mat-button
                  class="lf-list-item-button ml-2"
                  [class.disabled]="disabled"
                  [ngClass]="button.cssClass"
                  [disabled]="disabled"
                  [matTooltip]="button.tooltip"
                  (click)="clickButton({ buttonId: button.id, item }, $event)">
                  <!-- icon -->
                  @if (button.matIcon) {
                    <mat-icon [class.material-icons-outlined]="libraryConfig?.outlineIcons">
                      {{ button.matIcon }}
                    </mat-icon>
                  } @else if (button.svgIcon) {
                    <mat-icon [svgIcon]="button.svgIcon"></mat-icon>
                  }
                  {{ button.label }}
                </button>
              } @else {
                <button
                  mat-icon-button
                  class="lf-list-item-icon ml-2"
                  [class.disabled]="disabled"
                  [ngClass]="button.cssClass"
                  [disabled]="disabled"
                  [matTooltip]="button.tooltip"
                  (click)="clickButton({ buttonId: button.id, item }, $event)">
                  <!-- icon -->
                  @if (button.matIcon) {
                    <mat-icon [class.material-icons-outlined]="libraryConfig?.outlineIcons">
                      {{ button.matIcon }}
                    </mat-icon>
                  } @else if (button.svgIcon) {
                    <mat-icon [svgIcon]="button.svgIcon"></mat-icon>
                  }
                </button>
              }
            }
          }
        }

        <!-- drag -->
        @if (config?.enableDragging) {
          <button
            mat-icon-button
            class="lf-list-item-icon ml-2"
            [class.disabled]="item.disabled"
            [disabled]="item.disabled"
            (click)="stopPropagation($event)"
            cdkDragHandle>
            <mat-icon>drag_indicator</mat-icon>
          </button>
        }
      </div>

      <!-- checkbox -->
      @if (config?.enableSelection) {
        <div class="lf-list-item-checkbox ml-3">
          <mat-checkbox
            [(ngModel)]="item.checked"
            [disabled]="item.disabled!"
            (change)="selectItem(item, $event)"
            (click)="stopPropagation($event)"></mat-checkbox>
        </div>
      }
    </div>

    @if (config?.showDividers && !last) {
      <mat-divider></mat-divider>
    }
  </ng-template>
</div>
